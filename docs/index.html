<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name='viewport' content='width=device-width, height=device-height, initial-scale=1.0'>
    <title>Ping Me</title>
</head>
<body>
<noscript>
    <h2 style="color: #ff0000">Seems your browser doesn't support Javascript! Enable Javascript and reload this page!</h2>
</noscript>
<h1>Ping Me for iWatch</h1>
<h4>1st message will contain:</h4>
<h4><i>I'm on iWatch --> low connectivity</i></h4>
<button id="pingMe" type="submit">Just ping me</button>
<p id="result"></p>
<h3>Your text:</h3>
<h6>
    <label for="gim"></label><input type="text" id="gim" value=""/>
    <button id="buttonG">Send</button>
    <p id="resultGim"></p>
    <button id="msg1" type="submit">Predefined Message 1</button>
    <p id="result1"></p>
    <button id="msg2" type="submit">Predefined Message 2</button>
    <p id="result2"></p>
    <button id="repeatButton" type="submit">Please Repeat</button>
    <p id="repeatResult"></p>
    <button id="likeButton" type="submit">üëç</button>
    <p id="likeResult"></p>
    <img src="compass-app.png" alt="compass-app"/>
    <br/><br/>
    LAT:<label for="lat"></label><input type="text" id="lat" value="31.78822" size="8"/>
    <br/>
    LON:<label for="lon"></label><input type="text" id="lon" value="35.2029" size="8"/>
    <br/><br/>
    <button id="locationButton">Share Location</button>
    <p id="locationResult"></p>
    <img src="apple_maps_icon.png" alt="apple-maps-logo" width="72" height="72"/>
    <br/><br/>
    <button id="sanityButton">Self Check</button>
    <p id="sanityResult"></p>
</h6>
<script>

    <!-- navigator.geolocation is not available on iWatch -->
    function ping(text, field) {
        try {
            var xhr = new XMLHttpRequest();
            var url = "https://" + window.location.hostname;
            // var url = "http://localhost:8080";
            url += "/ping/" + text; // :8080/ping
            xhr.open('GET', url, true);
            xhr.timeout = 16000;
            xhr.onload = () => {
                // console.debug(xhr.status + "-" + xhr.responseText);
                // alert(xhr.responseText == "0" ? "success" : "failure");
                document.getElementById(field).innerHTML = "<h1>" + xhr.status + "</h1>";
            };
            xhr.ontimeout = (e) => {
                // alert("Timeout");
                // document.getElementById(field).innerHTML = "<h1>Timeout</h1>";
                document.getElementById(field).innerHTML = "<h1>Timeout " + xhr.status + e + "</h1>";
            };
            document.getElementById(field).innerHTML = "<h1>before xhr</h1>";
            xhr.send(null);
            document.getElementById(field).innerHTML = "<h1>after xhr</h1>";
        }
        catch (err) {
            // console.error(err);
            // alert(err);
            document.getElementById(field).innerHTML = "<h1>Error</h1>";
        }
    }

    document.getElementById("pingMe").addEventListener('click', function(e) {
        ping('0', 'result');
    });

    document.getElementById("msg1").addEventListener('click', function(e) {
        ping('1', 'result1');
    });

    document.getElementById("msg2").addEventListener('click', function(e) {
        ping('2', 'result2');
    });

    document.getElementById("buttonG").addEventListener('click', function(e) {
        ping(document.getElementById('gim').value, 'resultGim');
    });

    document.getElementById("repeatButton").addEventListener('click', function(e) {
        ping('Please repeat, message lost.', 'repeatResult');
    });

    document.getElementById("likeButton").addEventListener('click', function(e) {
        ping('Like', 'likeResult');
    });

    document.getElementById("sanityButton").addEventListener('click', function(e) {
        ping('sanityCheck', 'sanityResult');
    });

    // TODO if lat/lon is negative, put N/S, E/W in accordance.

    function getGoogleMapsLink() {
        return 'https://www.google.com/maps/place/' + document.getElementById('lat').value + 'N+' + document.getElementById('lon').value + 'E';
    }

    function getWazeLink() {
        return 'https://waze.com/ul!ll=' + document.getElementById('lat').value + '%2C' + document.getElementById('lon').value;
    }

    document.getElementById("locationButton").addEventListener('click', function(e) {
        let mapsLink = getGoogleMapsLink()
        let locUrl = mapsLink;
        locUrl += '    WAZE: ' + getWazeLink();
        locUrl = locUrl.replaceAll('/', '-');
        ping(locUrl, 'locationResult');
        document.getElementById('locationResult').innerHTML = document.getElementById('locationResult').innerHTML + "  " +
            "<a href=" + mapsLink + ">" + mapsLink + "</a>";
    });

</script>
</body>
</html>
